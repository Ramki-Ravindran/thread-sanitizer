#summary DeadlockDetector bundled with ThreadSanitizer

= Introduction =

The current Clang trunk version of !ThreadSanitizer has an *experimental*
(i.e. "untested", "no warranty", etc) detector of lock order inversions (potential deadlocks).

Current status:
  * Only `pthread_mutex_*`/`pthread_rwlock_*`/`pthread_spin_*` are supported.
  * Tested only on tiny test cases.
  * The bug reports are not as informative as they could be (yet).

Contribution is welcome, first of all in form of tests. 

=Algorithm=
The deadlock detector maintains a directed graph of lock acquisitions. 
When a lock B is acquired when a lock A is being held by the same thread, a directed edge `A=>B` is added to the lock acquisition graph.
A potential deadlock is reported when there is a cycle in the graph. 

= Usage =
Just use `TSAN_OPTIONS=detect_deadlocks=1` when running your tsan-instrumented program. 
{{{
% cat mutex_cycle2.c 
#include <pthread.h>

int main() {
  pthread_mutex_t mu1, mu2;
  pthread_mutex_init(&mu1, NULL);
  pthread_mutex_init(&mu2, NULL);

  // mu1 => mu2
  pthread_mutex_lock(&mu1);
  pthread_mutex_lock(&mu2);
  pthread_mutex_unlock(&mu2);
  pthread_mutex_unlock(&mu1);

  // mu2 => mu1
  pthread_mutex_lock(&mu2);
  pthread_mutex_lock(&mu1);  // <<<<<<< OOPS
  pthread_mutex_unlock(&mu1);
  pthread_mutex_unlock(&mu2);

  pthread_mutex_destroy(&mu1);
  pthread_mutex_destroy(&mu2);
}
% clang -g  -fsanitize=thread mutex_cycle2.c
% TSAN_OPTIONS=detect_deadlocks=1 ./a.out 
WARNING: ThreadSanitizer: lock-order-inversion (potential deadlock) (pid=18360)
  path: M0 => M1 => M0

  edge: M0 => M1
    #0 pthread_mutex_lock
    #1 main /tmp/mutex_cycle2.c:9 (a.out+0x00000008bad8)

    #0 pthread_mutex_lock
    #1 main /tmp/mutex_cycle2.c:10 (a.out+0x00000008bae4)

  edge: M1 => M0
    #0 pthread_mutex_lock
    #1 main /tmp/mutex_cycle2.c:15 (a.out+0x00000008bb08)

    #0 pthread_mutex_lock
    #1 main /tmp/mutex_cycle2.c:16 (a.out+0x00000008bb14)

  Mutex M0 (0x7fff29bae908) created at:
    #0 pthread_mutex_init
    #1 main /tmp/mutex_cycle2.c:5 (a.out+0x00000008bab6)

  Mutex M1 (0x7fff29bae8e0) created at:
    #0 pthread_mutex_init
    #1 main /tmp/mutex_cycle2.c:6 (a.out+0x00000008bacc)

SUMMARY: ThreadSanitizer: lock-order-inversion (potential deadlock) /tmp/mutex_cycle2.c:9 main
% 
}}}